<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>ZingGrid: Blank Grid</title>
	<script nonce="undefined" src="https://cdn.zingchart.com/zingchart.min.js"></script>
	<style>
	html,
	body {
		height: 100vh;
		width: 100%;
		margin: 0;
		padding: 0;
	}
	
	.chart--container {
		height: 100%; 
		width: 600px;
		min-height: 150px;
		margin: 0 auto ;
		margin-bottom: -22rem;
	}
	
	.zc-ref {
		display: none;
	}
	</style>
</head>
	
<body>
	<!-- CHART CONTAINER -->
	<div id="twoBar" class="chart--container">
	</div>
	<div id="twoLine" class="chart--container">
	</div>
	<div id="pie" class="chart--container">
	</div>
	<script>
	ZC.LICENSE = ["569d52cefae586f634c54f86dc99e6a9", "b55b025e438fa8a98e32482b5f768ff5"]; // window:load event for Javascript to run after HTML
	// because this Javascript is injected into the document head
	let mouseClicks = [0,0,0,0,0,0,0];
	let keys_down = [0,0,0,0,0,0,0];

	let todayMouseClicks = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
	let todayKeysDown = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
	function thisWeek(date) {
		const todayObj = new Date();
		const todayDate = todayObj.getDate();
		const todayDay = todayObj.getDay();

		// get first date of week
		const firstDayOfWeek = new Date(todayObj.setDate(todayDate - todayDay));

		// get last date of week
		const lastDayOfWeek = new Date(firstDayOfWeek);
		lastDayOfWeek.setDate(lastDayOfWeek.getDate() + 7);

		// if date is equal or within the first and last dates of the week
		return date >= firstDayOfWeek && date <= lastDayOfWeek;
	}

	function isToday(date) {
		const now = new Date();
		const msBetweenDates = Math.abs(date.getTime() - now.getTime());
		const hoursBetweenDates = msBetweenDates / (60 * 60 * 1000);
		return hoursBetweenDates <= 24 && now.getDay() == date.getDay();
	}

	window.addEventListener('load', function() {
		// Javascript code to execute after DOM content
	
		// full ZingChart schema can be found here:
		// https://www.zingchart.com/docs/api/json-configuration/
		fetch('/api/activity').then((res)=> res.json().then((json) => {
			json.map((row) => {
				if (thisWeek(new Date(row.created))) {
					let row_day = ((new Date(row.created)).getDay());
					if (row.keys_down != "")
						keys_down[row_day] += (JSON.parse(row.keys_down)).length;
					if (row.mouse_clicks != "")
						mouseClicks[row_day] += (JSON.parse(row.mouse_clicks)).length;
				}
				if (isToday(new Date(row.created))) {
					let row_hour = ((new Date(row.created)).getHours());
					console.log(row_hour);
					if (row.keys_down != "") {
						todayKeysDown[row_hour] += (JSON.parse(row.keys_down)).length;
					}
					if (row.mouse_clicks != "") {
						todayMouseClicks[row_hour] += (JSON.parse(row.mouse_clicks)).length;
					}
				}
			});
			const twoBar = {
					type: 'bar',
					title: {
						text: "This Week's Clicks vs. Key Presses",
						fontSize: 16,
						color: '#ffffff'
					},
					legend: {
						draggable: false,
					},
					scaleX: {
						// set scale label
						label: {
						text: 'Days'
						},
						// convert text on scale indices
						labels: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']
					},
					scaleY: {
						// scale label with unicode character
						label: {
						text: 'Count'
						}
					},
					plot: {
						// animation docs here:
						// https://www.zingchart.com/docs/tutorials/design-and-styling/chart-animation/#animation__effect
						animation: {
						effect: 'ANIMATION_EXPAND_BOTTOM',
						method: 'ANIMATION_STRONG_EASE_OUT',
						sequence: 'ANIMATION_BY_NODE',
						speed: 275,
						}
					},
					series: [{
						// plot 1 values, linear data
						values: mouseClicks,
						text: 'Clicks',
						backgroundColor: '#BBDBB4'
						},
						{
						// plot 2 values, linear data
						values: keys_down,
						text: 'Keys Pressed',
						backgroundColor: '#A64253'
						},
					],
			};
			zingchart.render({
				id: 'twoBar',
				data: twoBar,
				height: '50%',
				width: '100%'
			});
			const twoLine = {
				type: 'line',
				title: {
					text: "Today's Clicks vs. Key Presses",
					fontSize: 16,
					color: '#5d7d9a'
				},
				legend: {
					draggable: false,
				},
				scaleX: {
					// set scale label
					label: {
					text: 'Days'
					},
					// convert text on scale indices
					labels: ['1','2','3','4','5','6','7','8','9','10','11','12','13','14','15','16','17','18','19','20','21','22','23','24']
				},
				scaleY: {
					// scale label with unicode character
					label: {
					text: 'Count'
					}
				},
				plot: {
					// animation docs here:
					// https://www.zingchart.com/docs/tutorials/design-and-styling/chart-animation/#animation__effect
					animation: {
					effect: 'ANIMATION_EXPAND_BOTTOM',
					method: 'ANIMATION_STRONG_EASE_OUT',
					sequence: 'ANIMATION_BY_NODE',
					speed: 275,
					}
				},
				series: [{
					// plot 1 values, linear data
					values: todayKeysDown,
					text: 'Keys Pressed',
					backgroundColor: '#4d80a6'
					},
					{
					// plot 2 values, linear data
					values: todayMouseClicks,
					text: 'Mouse Clicks',
					backgroundColor: '#70cfeb'
					},
				]
			};	
			zingchart.render({
				id: 'twoLine',
				data: twoLine,
				height: '50%',
				width: '100%'
			});
		}));

		var pie = {
		type: "pie",
		plot: {
			borderColor: "#2B313B",
			borderWidth: 5,
			// slice: 90,
			valueBox: {
			placement: 'out',
			text: '%t\n%npv%',
			fontFamily: "Open Sans"
			},
			tooltip: {
			fontSize: '18',
			fontFamily: "Open Sans",
			padding: "5 10",
			text: "%npv%"
			},
			animation: {
			effect: 2,
			method: 5,
			speed: 900,
			sequence: 1,
			delay: 3000
			}
		},
		source: {
			text: 'gs.statcounter.com',
			fontColor: "#8e99a9",
			fontFamily: "Open Sans"
		},
		title: {
			fontColor: "#8e99a9",
			text: 'Global Browser Usage',
			align: "left",
			offsetX: 10,
			fontFamily: "Open Sans",
			fontSize: 25
		},
		subtitle: {
			offsetX: 10,
			offsetY: 10,
			fontColor: "#8e99a9",
			fontFamily: "Open Sans",
			fontSize: "16",
			text: 'May 2016',
			align: "left"
		},
		plotarea: {
			margin: "20 0 0 0"
		},
		series: [{
			values: [11.38],
			text: "Internet Explorer",
			backgroundColor: '#50ADF5',
			},
			{
			values: [56.94],
			text: "Chrome",
			backgroundColor: '#FF7965',
			detached: true
			},
			{
			values: [14.52],
			text: 'Firefox',
			backgroundColor: '#FFCB45',
			detached: true
			},
			{
			text: 'Safari',
			values: [9.69],
			backgroundColor: '#6877e5'
			},
			{
			text: 'Other',
			values: [7.48],
			backgroundColor: '#6FB07F'
			}
		]
		};
	
		zingchart.render({
		id: 'pie',
		data: pie,
		height: '100%',
		width: '100%'
		});
	
		// render chart with width and height to
		// fill the parent container CSS dimensions
	
	});
	</script>
</body>
	
</html>

